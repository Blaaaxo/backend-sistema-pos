// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TipoPersona {
  NATURAL
  JURIDICA
}

enum Regimen {
  COMUN
  SIMPLIFICADO
}

enum TipoImpuesto {
  IVA
  CONSUMO
  SALUDABLE
}

enum TipoMovimiento {
  ENTRADA
  SALIDA
  DEVOLUCION_COMPRA
  DEVOLUCION_VENTA
  AJUSTE
  TRASLADO
}

/// Modelo de usuario principal
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())

  profile               Profile?
  ingresoCompras        IngresoCompra[]
  devolucionesProveedor DevolucionesProveedor[]
  Kardex                Kardex[]
  traslados             TrasladosBodega[]
  ordenCompras          OrdenCompra[]
}

model ConfiguracionEmpresa {
  id              Int         @id @default(autoincrement())
  nombre          String
  nit             String      @unique
  tipo_persona    TipoPersona
  direccion       String?
  telefono        String?
  correo          String?
  representante   String? // Nombre del representante legal
  regimen         Regimen?
  resolucion_dian String? // Número de resolución DIAN si aplica
  fecha_creacion  DateTime    @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

/// Perfil extendido del usuario
model Profile {
  id        Int      @id @default(autoincrement())
  user_id   Int?     @unique
  firstName String
  lastName  String
  user      User?    @relation(fields: [user_id], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model Producto {
  id             Int      @id @default(autoincrement())
  Descripcion    String
  codigo         String   @unique
  precio_base    Decimal  @db.Decimal(12, 2)
  costo_promedio Decimal? @db.Decimal(12, 2)

  activo        Boolean @default(true)
  unidad_medida String

  proveedor_id Int
  proveedor    Proveedor @relation(fields: [proveedor_id], references: [id])

  categoria_id Int
  categoria    Categoria @relation(fields: [categoria_id], references: [id])

  iva_id       Int?
  iva          Impuestos? @relation("ProductoIva", fields: [iva_id], references: [id])
  consumo_id   Int?
  consumo      Impuestos? @relation("ProductoConsumo", fields: [consumo_id], references: [id])
  saludable_id Int?
  saludable    Impuestos? @relation("ProductoSaludable", fields: [saludable_id], references: [id])

  ingresosDetalle              IngresoCompraDetalle[]
  devolucionesProveedorDetalle DevolucionesProveedorDetalle[]
  kardex                       Kardex[]
  preciosHistorial             ProductoPrecioHistorial[]

  existenciasBodega ExistenciaProducto[] // Relación inversa con ExistenciaProducto
  transferencias    TrasladosBodega[] // Relación inversa con TransferenciaDetalle

  ordenCompraDetalles OrdenCompraDetalle[] // Relación inversa con OrdenCompraDetalle
  TrasladosaDetalle   TrasladosaDetalle[]
  presentaciones      PresentacionProducto[]
}

model PresentacionProducto {
  id           Int    @id @default(autoincrement())
  nombre       String // Ej: Caja de 12
  equivalencia Int // Ej: 12 unidades
  unidad_base  String // Ej: unidad, litro

  producto_id Int
  producto    Producto @relation(fields: [producto_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Bodega {
  id        Int      @id @default(autoincrement())
  nombre    String
  direccion String?
  ciudad_id Int
  ciudad    Ciudades @relation(fields: [ciudad_id], references: [id])

  productos             ExistenciaProducto[]
  ingresos              IngresoCompra[]
  devolucionesProveedor DevolucionesProveedor[]
  kardex                Kardex[]
  BodegaOrigen          TrasladosBodega[]       @relation("BodegaOrigen")
  BodegaDestino         TrasladosBodega[]       @relation("BodegaDestino")
}

model ExistenciaProducto {
  id          Int @id @default(autoincrement())
  producto_id Int
  bodega_id   Int

  stock_bueno    Int @default(0)
  stock_malo     Int @default(0)
  stock_transito Int @default(0)

  producto Producto @relation(fields: [producto_id], references: [id])
  bodega   Bodega   @relation(fields: [bodega_id], references: [id])

  @@unique([producto_id, bodega_id]) // evita duplicados por producto+bodega
}

model ProductoPrecioHistorial {
  id          Int      @id @default(autoincrement())
  producto_id Int
  producto    Producto @relation(fields: [producto_id], references: [id])

  precio_base  Decimal   @db.Decimal(12, 2)
  fecha_inicio DateTime
  fecha_fin    DateTime?
}

model Proveedor {
  id        Int     @id @default(autoincrement())
  nombre    String
  nit       String  @unique
  direccion String?
  telefono  String?
  correo    String?

  aplica_retefuente     Boolean  @default(false)
  porcentaje_retefuente Decimal? @db.Decimal(5, 2)
  aplica_reteica        Boolean  @default(false)
  porcentaje_reteica    Decimal? @db.Decimal(5, 2)

  compras     IngresoCompra[]
  productos   Producto[]
  ordebCompra OrdenCompra[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model OrdenCompra {
  id            Int      @id @default(autoincrement())
  fecha         DateTime @default(now())
  estado        String // 'pendiente' | 'recibida' | 'anulada'
  observaciones String?

  proveedor_id Int
  proveedor    Proveedor @relation(fields: [proveedor_id], references: [id])

  user_id Int
  user    User @relation(fields: [user_id], references: [id])

  detalles OrdenCompraDetalle[]
  ingresos IngresoCompra[] // Relación inversa para trazabilidad

  total_con_imp Decimal @db.Decimal(12, 2) // Total de la orden con impuestos
  total_sin_imp Decimal @db.Decimal(12, 2) // Total de la orden sin impuestos

  CreatedAt DateTime @default(now())
  UpdatedAt DateTime @default(now()) @updatedAt
}

model OrdenCompraDetalle {
  id          Int @id @default(autoincrement())
  orden_id    Int
  producto_id Int

  cantidad        Decimal @db.Decimal(12, 2)
  precio_unitario Decimal @db.Decimal(12, 2)

  iva_porcentaje       Decimal? @db.Decimal(5, 2)
  consumo_porcentaje   Decimal? @db.Decimal(5, 2)
  saludable_porcentaje Decimal? @db.Decimal(5, 2)

  orden    OrdenCompra @relation(fields: [orden_id], references: [id])
  producto Producto    @relation(fields: [producto_id], references: [id])
}

model IngresoCompra {
  id            Int      @id @default(autoincrement())
  fecha         DateTime @default(now())
  observaciones String?

  user_id         Int
  proveedor_id    Int
  bodega_id       Int
  orden_compra_id Int?

  total_con_imp Decimal @db.Decimal(12, 2)
  total_sin_imp Decimal @db.Decimal(12, 2)

  retefuente Decimal? @db.Decimal(12, 2)
  reteica    Decimal? @db.Decimal(12, 2)

  proveedor   Proveedor    @relation(fields: [proveedor_id], references: [id])
  bodega      Bodega       @relation(fields: [bodega_id], references: [id])
  user        User         @relation(fields: [user_id], references: [id])
  ordenCompra OrdenCompra? @relation(fields: [orden_compra_id], references: [id])

  detalles IngresoCompraDetalle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

model IngresoCompraDetalle {
  id               Int @id @default(autoincrement())
  ingresoCompra_id Int
  producto_id      Int

  cantidad        Decimal @db.Decimal(12, 2)
  precio_unitario Decimal @db.Decimal(12, 2)

  iva_porcentaje       Decimal? @db.Decimal(5, 2)
  iva_valor            Decimal? @db.Decimal(12, 2)
  consumo_porcentaje   Decimal? @db.Decimal(5, 2)
  consumo_valor        Decimal? @db.Decimal(12, 2)
  saludable_porcentaje Decimal? @db.Decimal(5, 2)
  saludable_valor      Decimal? @db.Decimal(12, 2)

  otros_costos Decimal? @db.Decimal(12, 2)
  costo_total  Decimal  @db.Decimal(12, 2)

  ingresoCompra IngresoCompra @relation(fields: [ingresoCompra_id], references: [id])
  producto      Producto      @relation(fields: [producto_id], references: [id])
}

model DevolucionesProveedor {
  id            Int      @id @default(autoincrement())
  motivo_salida String
  fecha         DateTime
  user_id       Int
  bodega_id     Int
  observaciones String?

  total_con_imp Decimal @db.Decimal(12, 2) // Total de la salida
  total_sin_imp Decimal @db.Decimal(12, 2) // Total sin impuestos

  bodega   Bodega                         @relation(fields: [bodega_id], references: [id])
  user     User                           @relation(fields: [user_id], references: [id])
  detalles DevolucionesProveedorDetalle[]

  createdAt DateTime @default(now())
}

model DevolucionesProveedorDetalle {
  id            Int                   @id @default(autoincrement())
  devolucion_id Int
  devolucion    DevolucionesProveedor @relation(fields: [devolucion_id], references: [id])

  producto_id Int
  producto    Producto @relation(fields: [producto_id], references: [id])

  cantidad       Decimal @db.Decimal(12, 2)
  costo_unitario Decimal @db.Decimal(12, 2)

  iva_porcentaje Decimal? @db.Decimal(5, 2)
  iva_valor      Decimal? @db.Decimal(12, 2)

  consumo_porcentaje Decimal? @db.Decimal(5, 2)
  consumo_valor      Decimal? @db.Decimal(12, 2)

  saludable_porcentaje Decimal? @db.Decimal(5, 2)
  saludable_valor      Decimal? @db.Decimal(12, 2)
}

model TrasladosBodega {
  id                Int      @id @default(autoincrement())
  fecha             DateTime
  bodega_origen_id  Int
  bodega_destino_id Int
  user_id           Int
  observaciones     String?

  bodega_origen  Bodega              @relation("BodegaOrigen", fields: [bodega_origen_id], references: [id])
  bodega_destino Bodega              @relation("BodegaDestino", fields: [bodega_destino_id], references: [id])
  user           User                @relation(fields: [user_id], references: [id])
  detalles       TrasladosaDetalle[]
  Producto       Producto?           @relation(fields: [productoId], references: [id])
  productoId     Int?
}

model TrasladosaDetalle {
  id               Int     @id @default(autoincrement())
  transferencia_id Int
  producto_id      Int
  cantidad         Decimal @db.Decimal(12, 2)

  traslados TrasladosBodega @relation(fields: [transferencia_id], references: [id])
  producto  Producto        @relation(fields: [producto_id], references: [id])
}

model Kardex {
  id          Int @id @default(autoincrement())
  producto_id Int
  bodega_id   Int

  fecha            DateTime
  tipo_movimiento  TipoMovimiento
  documento_origen String
  documento_id     Int

  cantidad         Int
  costo_unitario   Decimal @db.Decimal(12, 2)
  stock_resultante Int

  user_id       Int
  observaciones String?

  producto Producto @relation(fields: [producto_id], references: [id])
  bodega   Bodega   @relation(fields: [bodega_id], references: [id])
  user     User     @relation(fields: [user_id], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Departamentos {
  id          Int    @id @default(autoincrement())
  nombre      String @unique
  codigo_dane String @unique

  ciudades Ciudades[]
}

model Ciudades {
  id          Int    @id @default(autoincrement())
  nombre      String
  codigo_dane String @unique

  departamento_id Int
  departamento    Departamentos @relation(fields: [departamento_id], references: [id])
  bodegas         Bodega[]
  barrios         Barrios[]
}

model Barrios {
  id     Int    @id @default(autoincrement())
  nombre String

  ciudad_id Int
  ciudad    Ciudades @relation(fields: [ciudad_id], references: [id])
}

model Impuestos {
  id         Int     @id @default(autoincrement())
  nombre     String
  porcentaje Decimal @db.Decimal(5, 2)
  tipo       String // 'iva', 'consumo', 'saludable'

  productos          Producto[] @relation("ProductoIva")
  productosConsumo   Producto[] @relation("ProductoConsumo")
  productosSaludable Producto[] @relation("ProductoSaludable")
}

model Categoria {
  id          Int     @id @default(autoincrement())
  nombre      String  @unique
  descripcion String?

  productos Producto[]
}
